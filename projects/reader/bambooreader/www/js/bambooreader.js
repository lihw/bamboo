/**
 * bambooreader.js - The book organizer
 *
 * @category  Mobile-Hybrid
 * @package   bamboo
 * @author    Hongwei Li<lihw81@gmail.org>
 * @copyright 2012-2014 Future Interface
 * @license   MIT License
 * @version   0.1
 * @link      N/A
 * 
 *
 */

var BambooReader = {
    // The book name
    _bookTitle : "book",
    // The book info
    _bookInformation : { 
    _numberOfPages : 0,
    },
    // The current page number. The page number starts from 0 to _totalPageNumber - 1.
    _currentPageNumber : 0,
    // The current page object
    _currentPage : null,
    
    //
    // Opertions.
    //
    initialize: function() {
        // Bind the swiping gesture.
        $$('#wrapper').swipeLeft(function(){BambooReader.pageDown();});
        $$('#wrapper').swipeRight(function(){BambooReader.pageUp();});
        
        // Initialize the file system
        //window.requestFileSystem = window.requestFileSystem || window.webkitRequestFileSystem;
        //if (window.File && window.FileReader && window.FileList && window.Blob) {
        //    window.requestFileSystem(window.PERSISTENT, bamboo._fileSystemQuota, bamboo.onFileSystemInitialized, bamboo.onFileSystemError);
        //} else {
        //    bamboo.error("Failed to load file system. Quitting.");
        //}
    
        // Load the first few pages.
        var bookTitle = "Solar-System";
        this.openBook(bookTitle).then(function() {
            var numPages = BambooReader._bookInformation._numberOfPages? 
                3 : BambooReader._bookInformation._numberOfPages;
            if (numPages == 1) {
                BambooReader.openPage(1).done(function(htmlText) {
                    $('#wrapper').append('<div page="1" class="page center left">'+htmlText+'</div>');
                });
            } else if (numPages == 2) {
                BambooReader.openPage(1).then(function(htmlText) {
                    $('#wrapper').append('<div page="1" class="page center left">'+htmlText+'</div>');
                    return BambooReader.openPage(2);
                }).done(function(htmlText) {
                    $('#wrapper').append('<div page="2" class="page right">'+htmlText+'</div>');
                });
            } else {
                BambooReader.openPage(1).then(function(htmlText) {
                    $('#wrapper').append('<div page="1" class="page center left">'+htmlText+'</div>');
                    return BambooReader.openPage(2);
                }).then(function(htmlText) {
                    $('#wrapper').append('<div page="2" class="page right">'+htmlText+'</div>');
                    return BambooReader.openPage(3);
                }).done(function(htmlText) {
                    $('#wrapper').append('<div page="3" class="page right">'+htmlText+'</div>');
                });
            } 
            
            BambooReader._currentPageNumber = 1;
        }, function(error) {
            console.log('could not open book.' + bookTitle);
            BambooReader._currentPageNumber = 1;
        });

        BambooReader.info("BambooReader initialized.");
    },
    animatePage: function(nextPage, direction) {
        // Modify the CSS attributes of current page and next page.
        if (direction == "right") {
            // FIXME: Those embeded css() are to make css take effect immediately
            // after the HTML insertion by JQuery. It seems Sarafi doesn't apply
            // CSS to those dynamic content generated by JQuery.
            nextPage.attr('class', "page current right" );
            var tmp = $(nextPage).css("transform");
            nextPage.attr('class', "page current transition center");
            BambooReader._currentPage.attr('class', "page transition left" );
        } else {
            nextPage.attr('class', "page current left" );
            var tmp = $(nextPage).css("transform");
            nextPage.attr('class', "page current transition center");
            BambooReader._currentPage.attr('class', "page transition right" );
            //tmp = $(nextPage).css("transform");
            //this.debug(tmp);
        }
        
        // Setup current page
        BambooReader._currentPage.unbind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd");
        
        BambooReader._currentPage = nextPage;
        BambooReader._currentPageNumber = parseInt($(this._currentPage).attr('page'));
        
        BambooReader._currentPage.bind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd", 
            function() { BambooReader.onPageAnimationEnd(direction); });
    },
    pageDown: function() {
        // We are at the last page of the book, no way to page down.
        if (BambooReader._currentPageNumber >= BambooReader._bookInformation._numberOfPages) {
            return ;
        }

        BambooReader._currentPageNumber++;

        BambooReader._currentPage = $('#wrapper').find('.page.center');
        
        // Next page.
        var nextPage = BambooReader._currentPage.next().first();

        BambooReader.hidePageGL().then(function() {
            BambooReader.animatePage(nextPage, "right");

            // Check if the we are now reach the last visible page. If so
            // Load a few pages up.
            nextPage = BambooReader._currentPage.next().first();
            if (nextPage.length == 0) {
                // It is last visible page and we need to load 3 more new pages.
                var nextPageNumber = BambooReader._currentPageNumber + 1;

                BambooReader.openPage(nextPageNumber).then(function(htmlText) {
                    var pageNumberAttr = nextPageNumber;
                    var nextPageHtml = '<div page="' + pageNumberAttr + '" class="page right">'+htmlText+'</div>';
                    BambooReader._currentPage.parent().append(nextPageHtml);
                    
                    BambooReader.debug("after added, structure:" + $('#wrapper').html());

                    return BambooReader.openPage(nextPageNumber + 1);
                }).then(function(htmlText) {
                    var pageNumberAttr = nextPageNumber + 1;
                    var nextPageHtml = '<div page="' + pageNumberAttr + '" class="page right">'+htmlText+'</div>';
                    BambooReader._currentPage.parent().append(nextPageHtml);
                    
                    BambooReader.debug("after added, structure:" + $('#wrapper').html());

                    return BambooReader.openPage(nextPageNumber + 2)
                }).then(function(htmlText) {
                    var pageNumberAttr = nextPageNumber + 2;
                    var nextPageHtml = '<div page="' + pageNumberAttr + '" class="page right">'+htmlText+'</div>';
                    BambooReader._currentPage.parent().append(nextPageHtml);
                
                    BambooReader.debug("after added, structure:" + $('#wrapper').html());
                }).always (function() {
                    // Discard 3 heading pages.
                    var wrapper = BambooReader._currentPage.parent();
                    // The page number of the first visible page
                    var firstPageNumber = wrapper.children().first().attr('page'); 
                    for (var i = firstPageNumber; i < BambooReader._currentPageNumber - 1; ++i) {
                        BambooReader.info("page delete " + i);
                        wrapper.children().first().remove();
                    }
                    
                    BambooReader.debug("after deleted, structure:" + $('#wrapper').html());
                });
            }
        });
    },
    pageUp: function() {
        // We are at the last page of the book, no way to page down.
        if (BambooReader._currentPageNumber <= 1) {
            return ;
        }

        BambooReader._currentPageNumber--;

        BambooReader._currentPage = $('#wrapper').find('.page.center');
        
        // Previous page.
        var prevPage = BambooReader._currentPage.prev().first();

        BambooReader.hidePageGL().then(function() {
            BambooReader.animatePage(prevPage, "left");

            // Check if the we are now reach the last visible page. If so
            // Load a few pages up.
            prevPage = BambooReader._currentPage.prev().first();
            if (prevPage.length == 0) {
                // It is first visible page and we need to load 3 more new pages.
                var prevPageNumber = BambooReader._currentPageNumber - 1;

                BambooReader.openPage(prevPageNumber).then(function(htmlText) {
                    var pageNumberAttr = prevPageNumber;
                    var prevPageHtml = '<div page="' + pageNumberAttr + '" class="page left">'+htmlText+'</div>';
                    BambooReader._currentPage.parent().prepend(prevPageHtml);
                    BambooReader.debug("after added, structure:" + $('#wrapper').html());

                    return BambooReader.openPage(prevPageNumber - 1);
                }).then(function(htmlText) {
                    var pageNumberAttr = prevPageNumber - 1;
                    var prevPageHtml = '<div page="' + pageNumberAttr + '" class="page left">'+htmlText+'</div>';
                    BambooReader._currentPage.parent().prepend(prevPageHtml);
                    BambooReader.debug("after added, structure:" + $('#wrapper').html());

                    return BambooReader.openPage(prevPageNumber - 2)
                }).then(function(htmlText) {
                    var pageNumberAttr = prevPageNumber - 2;
                    var prevPageHtml = '<div page="' + pageNumberAttr + '" class="page left">'+htmlText+'</div>';
                    BambooReader._currentPage.parent().prepend(prevPageHtml);
                
                    BambooReader.debug("after added, structure:" + $('#wrapper').html());
                }).always(function() { 
                    // Discard 3 tailing pages.
                    var wrapper = BambooReader._currentPage.parent();
                    // The page number of the first visible page
                    var lastPageNumber = wrapper.children().last().attr('page'); 
                    for (var i = lastPageNumber; i > BambooReader._currentPageNumber + 1; --i) {
                        wrapper.children().last().remove();
                    }
                    BambooReader.debug("after deleted, structure:" + $('#wrapper').html());
                });
            }
        });
    },

    //
    // Event callbacks
    //
    openBookSucceed: function(bookInfo) {
        bamboo._bookInfo = JSON && JSON.parse(json) || $.parseJSON(json);
    },
    closeBookSucceed: function() {
        bamboo._bookTitle = null;
        bamboo._bookInfo = null;
    },
    onPageAnimationEnd: function(direction) {
        BambooReader.showPageGL(null, null);
    },

    //
    // Interface to the BambooReader cordova plugin
    //
    openBook: function(bookTitle) {
        var deferred = new $.Deferred();

        BambooReader._bookTitle = bookTitle;
        BambooReader._bookInformation._numberOfPages = 7;

        //cordova.exec(function(bookInformationText) {
        //                deferred.resolve(bookInformationText);
        //             },
        //            function() {
        //                BambooReader.error("(openBook): could not open book " + BambooReader._bookTitle);
        //            },
        //            "BambooReaderPlugin", "openBook", BambooReader._bookTitle);
        //setTimeout(function(){
        //    deferred.resolve();
        //}, 10);
        
        return deferred.promise();
    },
    closeBook: function() {
        cordova.exec(bamboo.closeBookSucceed,
                     function() {
                       alert("Failed to close book " + bamboo._bookTitle);
                     },
                     "BambooReaderPlugin", "closeBook", []);
    },
    openPage: function(pageNumber) {
        var deferred = new $.Deferred();
        
        if (BambooReader._bookInformation._numberOfPages == 0) {
            BambooReader.error("openPage: no book open yet.");
            deferred.reject();
            return deferred.promise();
        }
        if (pageNumber < 1 || pageNumber > BambooReader._bookInformation._numberOfPages) {
            BambooReader.error("openPage: invalide page number (" + pageNumber + ").");
            deferred.reject();
            return deferred.promise();
        }
        
        // Load the page
        cordova.exec(function(htmlText) {
                         deferred.resolve(htmlText);
                     },
                     function() {
                         Bamboo.error("openPage: could not to open page " + pageNumber);
                     },
                     "BambooReaderPlugin", "openPage", [pageNumber.toString()]);
        //setTimeout(function(){
        //    deferred.resolve('<h1 style="color: white">'+pageNumber+'</h1>');
        //}, 10);
        
        return deferred.promise();
    },
    showPageGL: function() {
        //cordova.exec(function() {
        //               bamboo.info("Showing GL succeeds.");
        //             },
        //             function() {
        //               bamboo.error("Failed to show GL content of current page.");
        //             },
        //             "BambooReaderPlugin", "openPageGL", []);
    },
    hidePageGL: function() {
        //cordova.exec(function() {
        //               bamboo.info("Hiding GL succeeds.");
        //             },
        //             function() {
        //               bamboo.error("Failed to hide GL content of current page.");
        //             },
        //             "BambooReaderPlugin", "hidePageGL", []);
        var deferred = new $.Deferred();

        setTimeout(function(){
            deferred.resolve();
        }, 10);
    
        return deferred.promise();
    },
    
    //
    // Debug
    //
    info: function(message) {
        console.log(message);
    },
    error: function(message) {
        console.log('(error): ' + message, 'background: #ff0000; color: #ffffff');
    },
    debug: function(message) {
        console.log('(debug): ' + message);
    },
};
